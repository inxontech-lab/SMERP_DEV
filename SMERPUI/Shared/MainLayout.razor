@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@inject IUserSessionService UserSessionService
@inject NavigationManager NavigationManager

<RadzenLayout>
    <RadzenHeader>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="0.75rem" Style="padding: 0.75rem 1rem;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                <RadzenSidebarToggle Click="@(() => sidebarExpanded = !sidebarExpanded)" />
                <RadzenText TextStyle="TextStyle.H5" Style="color: white;">INXON</RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                @if (!string.IsNullOrWhiteSpace(displayName))
                {
                    <RadzenText Style="color: white;">@displayName</RadzenText>
                    <RadzenButton Icon="logout" Text="Logout" Variant="Variant.Outlined" Shade="Shade.Light" Size="ButtonSize.Small" Click="HandleLogoutAsync" />
                }

                <RadzenButton
                    Icon="@(isDarkTheme ? "light_mode" : "dark_mode")"
                    Text="@(isDarkTheme ? "Light" : "Dark")"
                    Variant="Variant.Outlined"
                    Shade="Shade.Light"
                    Size="ButtonSize.Small"
                    Click="ToggleTheme" />
            </RadzenStack>
        </RadzenStack>
    </RadzenHeader>
    <RadzenSidebar @bind-Expanded="sidebarExpanded">
        <NavMenu />
    </RadzenSidebar>
    <RadzenBody>
        <div class="content px-4">
            @Body
        </div>
    </RadzenBody>
</RadzenLayout>

@code {
    private const string LightTheme = "material";
    private const string DarkTheme = "material-dark";

    private bool sidebarExpanded = true;
    private bool isDarkTheme;
    private string? displayName;

    protected override async Task OnParametersSetAsync()
    {
        var session = await UserSessionService.GetSessionAsync();

        if (session is null)
        {
            NavigationManager.NavigateTo("/login", forceLoad: true);
            return;
        }

        displayName = session.DisplayName;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        var savedTheme = await JSRuntime.InvokeAsync<string>("themeManager.getTheme");
        isDarkTheme = string.Equals(savedTheme, DarkTheme, StringComparison.OrdinalIgnoreCase);
        await ApplyTheme();
        StateHasChanged();
    }

    private async Task HandleLogoutAsync()
    {
        await UserSessionService.ClearSessionAsync();
        NavigationManager.NavigateTo("/login", forceLoad: true);
    }

    private async Task ToggleTheme()
    {
        isDarkTheme = !isDarkTheme;
        await ApplyTheme();
    }

    private async Task ApplyTheme()
    {
        var theme = isDarkTheme ? DarkTheme : LightTheme;
        await JSRuntime.InvokeVoidAsync("themeManager.setTheme", theme);
    }
}
