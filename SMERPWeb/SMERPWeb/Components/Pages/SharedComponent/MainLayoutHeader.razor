@render
@using Shared.Services.Auth
@using Shared.Services.Navigation

<RadzenRow JustifyContent="JustifyContent.Start" AlignItems="AlignItems.Center" Gap="0" class="topbar-row">
    <RadzenColumn Size="8" SizeMD="8" SizeLG="8">
        <RadzenStack AlignItems="AlignItems.Center" Orientation="Orientation.Horizontal" Gap="0.75rem" class="topbar-brand-wrap">
            <RadzenSidebarToggle Click="@SidebarToggleClick" class="topbar-toggle"></RadzenSidebarToggle>
            <RadzenStack AlignItems="AlignItems.Start" Gap="0" class="topbar-brand-text">
                @*  <img src="images/inxon-logo.png" alt="Inxon logo" class="topbar-logo" /> *@
                <RadzenText Text="@CurrentModuleTitle" class="app-subtitle" Style="font-size:large;" />
            </RadzenStack>
        </RadzenStack>
    </RadzenColumn>
    <RadzenColumn Size="4" SizeMD="4" SizeLG="4">
        <RadzenStack AlignItems="AlignItems.Center" Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.6rem" class="topbar-actions">
            <RadzenButton Text="Modules" Icon="apps" Size="ButtonSize.Small" Variant="Variant.Outlined" Click="@NavigateToModuleLanding" />
            @if (!string.IsNullOrWhiteSpace(UserBadgeText))
            {
                <RadzenText Text="@UserBadgeText" class="app-user-badge" />
            }
            <RadzenProfileMenu Click="@ProfileMenuClick" class="topbar-profile-menu">
                <ChildContent>
                    <RadzenProfileMenuItem Text="Logout" Value="Logout" Icon="power_settings_new" />
                </ChildContent>
                <Template>
                </Template>
            </RadzenProfileMenu>
        </RadzenStack>
    </RadzenColumn>
</RadzenRow>
@code {
    [Parameter] public EventCallback OnSidebarToggle { get; set; }

    [Inject] protected IUserSessionService UserSessionService { get; set; } = default!;
    [Inject] protected INavigationCatalogService NavigationCatalogService { get; set; } = default!;
    [Inject] protected NavigationManager NavigationManager { get; set; } = default!;

    private string? UserBadgeText { get; set; }
    private NavigationSnapshot? NavigationSnapshot { get; set; }
    private string CurrentModuleTitle { get; set; } = "Workspace";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        var session = await UserSessionService.GetSessionAsync();
        if (session is null)
        {
            NavigationManager.NavigateTo("/", true);
            return;
        }

        var displayName = string.IsNullOrWhiteSpace(session.DisplayName) ? session.Username : session.DisplayName;
        UserBadgeText = string.IsNullOrWhiteSpace(session.TenantName)
            ? displayName
            : $"{displayName} ({session.TenantName})";

        NavigationSnapshot = await NavigationCatalogService.BuildSnapshotAsync(session);
        CurrentModuleTitle = NavigationSnapshot.SelectedModule is null
            ? "Workspace"
            : NavigationSnapshot.Modules.FirstOrDefault(m => m.Key == NavigationSnapshot.SelectedModule)?.Name ?? "Workspace";

        EnforceFormAuthorization(NavigationSnapshot);
        StateHasChanged();
    }

    private Task SidebarToggleClick() => OnSidebarToggle.InvokeAsync();

    private void EnforceFormAuthorization(NavigationSnapshot snapshot)
    {
        var currentPath = "/" + NavigationManager.ToBaseRelativePath(NavigationManager.Uri).Split('?', '#')[0].Trim('/');
        if (currentPath == "//" || currentPath == "/")
        {
            currentPath = "/";
        }

        var safePaths = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "/",
            "/module-landing",
            "/Home"
        };

        if (safePaths.Contains(currentPath))
        {
            return;
        }

        if (!snapshot.AllowedPaths.Contains(currentPath))
        {
            NavigationManager.NavigateTo(snapshot.AllowedPaths.FirstOrDefault() ?? "/Home", true);
        }
    }

    private async Task ProfileMenuClick(RadzenProfileMenuItem args)
    {
        if (args.Value?.ToString() == "Logout")
        {
            await UserSessionService.ClearSessionAsync();
            NavigationManager.NavigateTo("/", true);
        }
    }

    private void NavigateToModuleLanding() => NavigationManager.NavigateTo("/module-landing", true);
}
